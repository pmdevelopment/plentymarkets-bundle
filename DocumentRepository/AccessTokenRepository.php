<?php

namespace PM\PlentyMarketsBundle\DocumentRepository;

use Doctrine\Bundle\MongoDBBundle\Repository\ServiceDocumentRepository;
use Doctrine\Bundle\MongoDBBundle\ManagerRegistry;
use PM\PlentyMarketsBundle\Component\Interfaces\AccessTokenRepositoryInterface;
use PM\PlentyMarketsBundle\Document\AccessToken;

/**
 * AccessTokenRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AccessTokenRepository extends ServiceDocumentRepository implements AccessTokenRepositoryInterface
{
    /**
     * AccessTokenRepository constructor.
     */
    public function __construct(ManagerRegistry $registry)
    {
        parent::__construct($registry, AccessToken::class);
    }

    /**
     * Find One By Api
     *
     * @param string $api
     *
     * @return mixed|null
     */
    public function findOneByApi(string $api): mixed
    {
        $tokens = $this->findBy(
            [
                'api' => $api,
            ],
            [
                'validUntil' => 'desc',
            ],
            1
        );

        if (0 === count($tokens)) {
            return null;
        }

        $token = reset($tokens);

        if ($token->getValidUntil() > (new \DateTime())) {
            return $token;
        }

        return null;
    }
}
